version: 0.2

cache:
  paths: []

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Install phase started"
      - npm ci
  build:
    commands:
      - echo "Running Next.js build"
      - npm run build

  post_build:
    commands:
      - echo "Triggering SSM command to EC2 instance"
      - |
        aws ssm send-command \
          --document-name "AWS-RunPowerShellScript" \
          --targets "Key=tag:Name,Values=WindowsInstance" \
          --comment "Deploy Next.js app on EC2" \
          --parameters '{"commands":[
              "cd C:\\Users\\Administrator\\nextjs-app",
              "git reset --hard",
              "git pull origin main",
              "npm install -g pm2",
              "npm ci",
              "npm run build",
              "pm2 stop all",
              "pm2 start npm --name nextjs-app -- run start",
              "pm2 save"
          ]}' \
          --region us-east-1 \
          --output text

artifacts:
  files:
    - '**/*'
  base-directory: '.next'
  discard-paths: yes
